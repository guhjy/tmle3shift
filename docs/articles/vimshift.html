<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Variable Importance with Grids of Stochastic Interventions • tmle3shift</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Variable Importance with Grids of Stochastic Interventions">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115145808-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115145808-1');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tmle3shift</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="https://tlverse.org">tlverse</a>
</li>
<li>
  <a href="../index.html">tmle3</a>
</li>
<li>
  <a href="../articles/shift_tmle.html">Overview</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/tlverse/tmle3shift">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Variable Importance with Grids of Stochastic Interventions</h1>
                        <h4 class="author">
<a href="https://nimahejazi.org">Nima S. Hejazi</a>, <a href="https://github.com/jeremyrcoyle">Jeremy R. Coyle</a>, and <a href="https://vanderlaan-lab.org">Mark J. van der Laan</a>
</h4>
            
            <h4 class="date">2018-09-04</h4>
      
      
      <div class="hidden name"><code>vimshift.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>Stochastic treatment regimes present a relatively simple manner in which to assess the effects of continuous treatments by way of parameters that examine the effects induced by the counterfactual shifting of the observed values of a treatment of interest. Here, we present an implementation of a new algorithm for computing targeted minimum loss-based estimates of treatment shift parameters defined based on a shifting function <span class="math inline">\(d(A,W)\)</span>. For a technical presentation of the algorithm, the interested reader is invited to consult <span class="citation">Díaz and van der Laan (2018)</span>. For additional background on Targeted Learning and previous work on stochastic treatment regimes, please consider consulting <span class="citation">van der Laan and Rose (2011)</span>, <span class="citation">van der Laan and Rose (2018)</span>, and <span class="citation">Díaz and van der Laan (2012)</span>.</p>
<p>To start, let’s load the packages we’ll use and set a seed for simulation:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">library</span>(data.table)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw">library</span>(condensier)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw">library</span>(ranger)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="kw">library</span>(sl3)</a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="kw">library</span>(tmle3)</a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="kw">library</span>(tmle3shift)</a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="kw">set.seed</span>(<span class="dv">429153</span>)</a></code></pre></div>
<hr>
</div>
<div id="data-and-notation" class="section level2">
<h2 class="hasAnchor">
<a href="#data-and-notation" class="anchor"></a>Data and Notation</h2>
<ol style="list-style-type: decimal">
<li><p>Start with a simple additive shift – i.e., <span class="math inline">\(d(a,w) = a + \delta\)</span> if <span class="math inline">\(a &lt; u(w) - \delta\)</span> or <span class="math inline">\(d(a, w) = a\)</span> if <span class="math inline">\(a \geq u(w) - \delta\)</span>.</p></li>
<li><p>The additive shift will have support everywhere (i.e., <span class="math inline">\(a &lt; u(w)\)</span> is true everywhere).</p></li>
<li><p>The data structure that we now observe is <span class="math inline">\(O = (W, A, Y)\)</span>.</p></li>
</ol>
<div id="simulate-data" class="section level3">
<h3 class="hasAnchor">
<a href="#simulate-data" class="anchor"></a>Simulate Data</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># simulate simple data for tmle-shift sketch</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">n_obs &lt;-<span class="st"> </span><span class="dv">1000</span> <span class="co"># number of observations</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3">n_w &lt;-<span class="st"> </span><span class="dv">1</span> <span class="co"># number of baseline covariates</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4">tx_mult &lt;-<span class="st"> </span><span class="dv">2</span> <span class="co"># multiplier for the effect of W = 1 on the treatment</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="co"># baseline covariates -- simple, binary</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7">W &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">replicate</span>(n_w, <span class="kw">rbinom</span>(n_obs, <span class="dv">1</span>, <span class="fl">0.5</span>)))</a>
<a class="sourceLine" id="cb2-8" data-line-number="8"></a>
<a class="sourceLine" id="cb2-9" data-line-number="9"><span class="co"># create treatment based on baseline W</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10">A &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">rnorm</span>(n_obs, <span class="dt">mean =</span> tx_mult <span class="op">*</span><span class="st"> </span>W, <span class="dt">sd =</span> <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb2-11" data-line-number="11"></a>
<a class="sourceLine" id="cb2-12" data-line-number="12"><span class="co"># create outcome as a linear function of A, W + white noise</span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13">Y &lt;-<span class="st"> </span>A <span class="op">+</span><span class="st"> </span>W <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(n_obs, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb2-14" data-line-number="14"></a>
<a class="sourceLine" id="cb2-15" data-line-number="15"><span class="co"># organize data and nodes for tmle3</span></a>
<a class="sourceLine" id="cb2-16" data-line-number="16">data &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/data.table">data.table</a></span>(W, A, Y)</a>
<a class="sourceLine" id="cb2-17" data-line-number="17">node_list &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">W =</span> <span class="st">"W"</span>, <span class="dt">A =</span> <span class="st">"A"</span>, <span class="dt">Y =</span> <span class="st">"Y"</span>)</a></code></pre></div>
<p>The above composes our observed data structure <span class="math inline">\(O = (W, A, Y)\)</span>. To formally express this fact using the <code>tlverse</code> grammar introduced by the <code>tmle3</code> package, we create a single data object and specify the functional relationships between the nodes in the <em>directed acyclic graph</em> (DAG) via <em>nonparametric structural equation models</em> (NPSEMs), reflected in the node list that we set up:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co"># organize data and nodes for tmle3</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">data &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/data.table">data.table</a></span>(W, A, Y)</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">node_list &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">W =</span> <span class="st">"W"</span>, <span class="dt">A =</span> <span class="st">"A"</span>, <span class="dt">Y =</span> <span class="st">"Y"</span>)</a></code></pre></div>
<p>We now have an observed data structure (<code>data</code>) and a specification of the role that each variable in the data set plays as the nodes in a DAG.</p>
<hr>
</div>
</div>
<div id="methodology" class="section level2">
<h2 class="hasAnchor">
<a href="#methodology" class="anchor"></a>Methodology</h2>
<div id="defining-a-grid-of-counterfactual-interventions" class="section level3">
<h3 class="hasAnchor">
<a href="#defining-a-grid-of-counterfactual-interventions" class="anchor"></a>Defining a grid of counterfactual interventions</h3>
<p>In order to specify a <em>grid</em> of shifts <span class="math inline">\(\delta\)</span> to be used in defining a set of stochastic intervention policies in an <em>a priori</em> manner, let us consider an arbitrary scalar <span class="math inline">\(\delta\)</span> that defines a counterfactual outcome <span class="math inline">\(\psi_n = Q_n(d(A, W), W)\)</span>, where, for simplicity, let <span class="math inline">\(d(A, W) = A + \delta\)</span>. A simplified expression of the auxiliary covariate for the TMLE of <span class="math inline">\(\psi\)</span> is <span class="math inline">\(H_n = \frac{g^*(a \mid w)}{g(a \mid w)}\)</span>, where <span class="math inline">\(g^*(a \mid w)\)</span> defines the treatment mechanism with the stochastic intervention implemented. Then, to ascertain whether a given choice of the shift <span class="math inline">\(\delta\)</span> is admissable (in the sense of avoiding violations of the positivity assumption), let there be a bound <span class="math inline">\(C(\delta) = \frac{g^*(a \mid w)}{g(a \mid w)} &lt; M\)</span>, where <span class="math inline">\(g^*(a \mid w)\)</span> is a function of <span class="math inline">\(\delta\)</span> in part, and <span class="math inline">\(M\)</span> is a potentially user-specified upper bound of <span class="math inline">\(C(\delta)\)</span>. Then, <span class="math inline">\(C(\delta)\)</span> is a measure of the influence of a given observation (under a bound of the conditional densities), which provides a way to limit the maximum influence of a given observation through a choice of the shift <span class="math inline">\(\delta\)</span>.</p>
<p>We formalize and extend the procedure to determine an acceptable set of values for the shift <span class="math inline">\(\delta\)</span> in the sequel. Specifically, let there be a shift <span class="math inline">\(d(A, W) = A + \delta(A, W)\)</span>, where the shift <span class="math inline">\(\delta(A, W)\)</span> is defined as <span class="math display">\[\begin{equation}
  \delta(a, w) =
    \begin{cases}
      \delta, &amp; \delta_{\text{min}}(a,w) \leq \delta \leq
        \delta_{\text{max}}(a,w) \\
      \delta_{\text{max}}(a,w), &amp; \delta \geq \delta_{\text{max}}(a,w) \\
      \delta_{\text{min}}(a,w), &amp; \delta \leq \delta_{\text{min}}(a,w) \\
    \end{cases},
\end{equation}\]</span> where <span class="math display">\[\delta_{\text{max}}(a, w) = \text{argmax}_{\left\{\delta \geq 0,
\frac{g(a - \delta \mid w)}{g(a \mid w)} \leq M \right\}} \frac{g(a - \delta
\mid w)}{g(a \mid w)}\]</span> and <span class="math display">\[\delta_{\text{min}}(a, w) = \text{argmin}_{\left\{\delta \leq 0,
\frac{g(a - \delta \mid w)}{g(a \mid w)} \leq M \right\}} \frac{g(a - \delta
\mid w)}{g(a \mid w)}.\]</span></p>
<p>The above provides a strategy for implementing a shift at the level of a given observation <span class="math inline">\((a_i, w_i)\)</span>, thereby allowing for all observations to be shifted to an appropriate value – whether <span class="math inline">\(\delta_{\text{min}}\)</span>, <span class="math inline">\(\delta\)</span>, or <span class="math inline">\(\delta_{\text{max}}\)</span>.</p>
</div>
<div id="interlude-constructing-optimal-stacked-regressions-with-sl3" class="section level3">
<h3 class="hasAnchor">
<a href="#interlude-constructing-optimal-stacked-regressions-with-sl3" class="anchor"></a><em>Interlude:</em> Constructing Optimal Stacked Regressions with <code>sl3</code>
</h3>
<p>To easily incorporate ensemble machine learning into the estimation procedure, we rely on the facilities provided in the <a href="https://sl3.tlverse.org"><code>sl3</code> R package</a>. For a complete guide on using the <code>sl3</code> R package, consider consulting <a href="https://sl3.tlverse.org" class="uri">https://sl3.tlverse.org</a>, or <a href="https://tlverse.org" class="uri">https://tlverse.org</a> for the <a href="https://github.com/tlverse"><code>tlverse</code> ecosystem</a>, of which <code>sl3</code> is a major part.</p>
<p>Using the framework provided by the <a href="https://sl3.tlverse.org"><code>sl3</code> package</a>, the nuisance parameters of the TML estimator may be fit with ensemble learning, using the cross-validation framework of the Super Learner algorithm of <span class="citation">van der Laan, Polley, and Hubbard (2007)</span>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># learners used for conditional expectation regression (e.g., outcome)</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">lrn1 &lt;-<span class="st"> </span>Lrnr_mean<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">lrn2 &lt;-<span class="st"> </span>Lrnr_glm_fast<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">lrn3 &lt;-<span class="st"> </span>Lrnr_ranger<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">sl_lrn &lt;-<span class="st"> </span>Lrnr_sl<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">  <span class="dt">learners =</span> <span class="kw">list</span>(lrn1, lrn2, lrn3),</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">  <span class="dt">metalearner =</span> Lrnr_nnls<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb4-8" data-line-number="8">)</a>
<a class="sourceLine" id="cb4-9" data-line-number="9"></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="co"># learners used for conditional density regression (e.g., propensity score)</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11">lrn1_dens &lt;-<span class="st"> </span>Lrnr_condensier<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb4-12" data-line-number="12">  <span class="dt">nbins =</span> <span class="dv">25</span>, <span class="dt">bin_estimator =</span> lrn1,</a>
<a class="sourceLine" id="cb4-13" data-line-number="13">  <span class="dt">bin_method =</span> <span class="st">"dhist"</span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14">)</a>
<a class="sourceLine" id="cb4-15" data-line-number="15">lrn2_dens &lt;-<span class="st"> </span>Lrnr_condensier<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb4-16" data-line-number="16">  <span class="dt">nbins =</span> <span class="dv">15</span>, <span class="dt">bin_estimator =</span> lrn2,</a>
<a class="sourceLine" id="cb4-17" data-line-number="17">  <span class="dt">bin_method =</span> <span class="st">"dhist"</span></a>
<a class="sourceLine" id="cb4-18" data-line-number="18">)</a>
<a class="sourceLine" id="cb4-19" data-line-number="19">lrn3_dens &lt;-<span class="st"> </span>Lrnr_condensier<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb4-20" data-line-number="20">  <span class="dt">nbins =</span> <span class="dv">20</span>, <span class="dt">bin_estimator =</span> lrn3,</a>
<a class="sourceLine" id="cb4-21" data-line-number="21">  <span class="dt">bin_method =</span> <span class="st">"dhist"</span></a>
<a class="sourceLine" id="cb4-22" data-line-number="22">)</a>
<a class="sourceLine" id="cb4-23" data-line-number="23">sl_lrn_dens &lt;-<span class="st"> </span>Lrnr_sl<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb4-24" data-line-number="24">  <span class="dt">learners =</span> <span class="kw">list</span>(lrn1_dens, lrn2_dens, lrn3_dens),</a>
<a class="sourceLine" id="cb4-25" data-line-number="25">  <span class="dt">metalearner =</span> Lrnr_solnp_density<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb4-26" data-line-number="26">)</a></code></pre></div>
<p>As seen above, we can generate two different ensemble learners for the two nuisance regressions that must be fit in the process of computing this TML estimator. In particular, we use a Super Learner composed of an intercept model, a GLM, and a random forest (as implemented in <a href="cran.r-project.org/package=ranger">the <code>ranger</code> R package</a>) for fitting the outcome regressions (often denoted “Q” in the literature) while we use variations of these learners, through <a href="https://github.com/osofr/condensier">the <code>condensier</code> R package</a>, for the conditional density estimation needed in fitting the treatment mechanism (often denoted “g” in the literature).</p>
<p>We make the above explicit with respect to standard notation by bundling the ensemble learners into a list object below:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co"># specify outcome and treatment regressions and create learner list</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">Q_learner &lt;-<span class="st"> </span>sl_lrn</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">g_learner &lt;-<span class="st"> </span>sl_lrn_dens</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">learner_list &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">Y =</span> Q_learner, <span class="dt">A =</span> g_learner)</a></code></pre></div>
<p>The <code>learner_list</code> object above specifies the role that each of the ensemble learners we’ve generated is to play in computing initial estimators to be used in building a TMLE for the parameter of interest here. In particular, it makes explicit the fact that our <code>Q_learner</code> is used in fitting the outcome regression while our <code>g_learner</code> is used in fitting our treatment mechanism regression.</p>
</div>
<div id="initializing-vimshift-through-its-tmle3_spec" class="section level3">
<h3 class="hasAnchor">
<a href="#initializing-vimshift-through-its-tmle3_spec" class="anchor"></a>Initializing <code>vimshift</code> through its <code>tmle3_Spec</code>
</h3>
<p>To start, we will initialize a specification for the TMLE of our parameter of interest (called a <code>tmle3_Spec</code> in the <code>tlverse</code> nomenclature) simply by calling <code>tmle_shift</code>. We specify the argument <code>shift_grid = seq(-0.5, 0.5, by = 0.5)</code> when initializing the <code>tmle3_Spec</code> object to communicate that we’re interested in assessing the mean counterfactual outcome over a grid of shifts -0.5, 0, 0.5 on the scale of the treatment <span class="math inline">\(A\)</span> (note that the numerical choice of shift is an arbitrarily chosen set of values for this example).</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co"># what's the grid of shifts we wish to consider?</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">delta_grid &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb6-3" data-line-number="3"></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="co"># initialize a tmle specification</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5">tmle_spec &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tmle_vimshift.html">tmle_vimshift</a></span>(<span class="dt">shift_grid =</span> delta_grid, <span class="dt">max_shifted_ratio =</span> <span class="dv">2</span>)</a></code></pre></div>
<p>As seen above, the <code>tmle_vimshift</code> specification object (like all <code>tmle3_Spec</code> objects) does <em>not</em> store the data for our specific analysis of interest. Later, we’ll see that passing a data object directly to the <code>tmle3</code> wrapper function, alongside the instantiated <code>tmle_spec</code>, will serve to construct a <code>tmle3_Task</code> object internally (see the <code>tmle3</code> documentation for details).</p>
</div>
<div id="targeted-estimation-of-stochastic-interventions-effects" class="section level3">
<h3 class="hasAnchor">
<a href="#targeted-estimation-of-stochastic-interventions-effects" class="anchor"></a>Targeted Estimation of Stochastic Interventions Effects</h3>
<p>One may walk through the step-by-step procedure for fitting the TML estimator of the mean counterfactual outcome under each shift in the grid, using the machinery exposed by the <a href="https://tmle3.tlverse.org/"><code>tmle3</code> R package</a> (see below); however, the step-by-step procedure is often not of interest.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="co"># NOT RUN -- SEE NEXT CODE CHUNK</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="co"># define data (from tmle3_Spec base class)</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4">tmle_task &lt;-<span class="st"> </span>tmle_spec<span class="op">$</span><span class="kw">make_tmle_task</span>(data, node_list)</a>
<a class="sourceLine" id="cb7-5" data-line-number="5"></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="co"># define likelihood (from tmle3_Spec base class)</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7">likelihood_init &lt;-<span class="st"> </span>tmle_spec<span class="op">$</span><span class="kw">make_initial_likelihood</span>(tmle_task, learner_list)</a>
<a class="sourceLine" id="cb7-8" data-line-number="8"></a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="co"># define update method (fluctuation submodel and loss function)</span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10">updater &lt;-<span class="st"> </span>tmle_spec<span class="op">$</span><span class="kw">make_updater</span>()</a>
<a class="sourceLine" id="cb7-11" data-line-number="11">likelihood_targeted &lt;-<span class="st"> </span>Targeted_Likelihood<span class="op">$</span><span class="kw">new</span>(likelihood_init, updater)</a>
<a class="sourceLine" id="cb7-12" data-line-number="12"></a>
<a class="sourceLine" id="cb7-13" data-line-number="13"><span class="co"># invoke params specified in spec</span></a>
<a class="sourceLine" id="cb7-14" data-line-number="14">tmle_params &lt;-<span class="st"> </span>tmle_spec<span class="op">$</span><span class="kw">make_params</span>(tmle_task, likelihood_targeted)</a>
<a class="sourceLine" id="cb7-15" data-line-number="15">updater<span class="op">$</span>tmle_params &lt;-<span class="st"> </span>tmle_params</a>
<a class="sourceLine" id="cb7-16" data-line-number="16"></a>
<a class="sourceLine" id="cb7-17" data-line-number="17"><span class="co"># fit TML estimator update</span></a>
<a class="sourceLine" id="cb7-18" data-line-number="18">tmle_fit &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/tmle3/topics/tmle3_Fit">fit_tmle3</a></span>(tmle_task, likelihood_targeted, tmle_params, updater)</a>
<a class="sourceLine" id="cb7-19" data-line-number="19"></a>
<a class="sourceLine" id="cb7-20" data-line-number="20"><span class="co"># extract results from tmle3_Fit object</span></a>
<a class="sourceLine" id="cb7-21" data-line-number="21">tmle_fit</a></code></pre></div>
<p>Instead, one may invoke the <code>tmle3</code> convenience function to fit the series of TML estimators (one for each parameter defined by the grid delta) in a single function call:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="co"># fit the TML estimator</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">tmle_fit &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/tmle3/topics/tmle3">tmle3</a></span>(tmle_spec, data, node_list, learner_list)</a></code></pre></div>
<pre><code>## speedglm::speedglm.wfit failed, falling back on stats:glm.fit; Error in solve.default(XTX, XTz, tol = tol.solve) : 
##   Lapack routine dgesv: system is exactly singular: U[2,2] = 0
## 
## speedglm::speedglm.wfit failed, falling back on stats:glm.fit; Error in solve.default(XTX, XTz, tol = tol.solve) : 
##   Lapack routine dgesv: system is exactly singular: U[2,2] = 0
## 
## speedglm::speedglm.wfit failed, falling back on stats:glm.fit; Error in solve.default(XTX, XTz, tol = tol.solve) : 
##   Lapack routine dgesv: system is exactly singular: U[2,2] = 0
## 
## speedglm::speedglm.wfit failed, falling back on stats:glm.fit; Error in solve.default(XTX, XTz, tol = tol.solve) : 
##   Lapack routine dgesv: system is exactly singular: U[2,2] = 0
## 
## speedglm::speedglm.wfit failed, falling back on stats:glm.fit; Error in solve.default(XTX, XTz, tol = tol.solve) : 
##   Lapack routine dgesv: system is exactly singular: U[2,2] = 0</code></pre>
<pre><code>## 
## Iter: 1 fn: 1827.3543     Pars:  0.888376035 0.111622806 0.000001158
## Iter: 2 fn: 1827.3543     Pars:  0.8883760499 0.1116233303 0.0000006198
## solnp--&gt; Completed in 2 iterations
## 
## density meta-learner fit:
## Lrnr_condensier_dhist_25_20_FALSE_NA_FALSE_NULL 
##                                    8.883760e-01 
## Lrnr_condensier_dhist_15_20_FALSE_NA_FALSE_NULL 
##                                    1.116233e-01 
## Lrnr_condensier_dhist_20_20_FALSE_NA_FALSE_NULL 
##                                    6.198196e-07</code></pre>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">tmle_fit</a></code></pre></div>
<pre><code>## A tmle3_Fit that took 1 step(s)
##    type         param  init_est tmle_est         se     lower     upper
## 1:  TSM E[Y_{A=NULL}] 0.5999507 0.604834 0.06315805 0.4810465 0.7286215
## 2:  TSM E[Y_{A=NULL}] 1.0481937 1.058459 0.06634296 0.9284288 1.1884885
## 3:  TSM E[Y_{A=NULL}] 1.5427535 1.543276 0.06656993 1.4128016 1.6737509
## 4:  TSM E[Y_{A=NULL}] 2.0352548 2.041327 0.06514262 1.9136494 2.1690037
## 5:  TSM E[Y_{A=NULL}] 2.4907026 2.495396 0.06071568 2.3763950 2.6143960
##    psi_transformed lower_transformed upper_transformed
## 1:        0.604834         0.4810465         0.7286215
## 2:        1.058459         0.9284288         1.1884885
## 3:        1.543276         1.4128016         1.6737509
## 4:        2.041327         1.9136494         2.1690037
## 5:        2.495396         2.3763950         2.6143960</code></pre>
<p><em>Remark</em>: The <code>print</code> method of the resultant <code>tmle_fit</code> object conveniently displays the results from computing our TML estimator.</p>
</div>
<div id="inference-with-marginal-structural-models" class="section level3">
<h3 class="hasAnchor">
<a href="#inference-with-marginal-structural-models" class="anchor"></a>Inference with Marginal Structural Models</h3>
<p>In the directly preceding section, we consider estimating the mean counterfactual outcome <span class="math inline">\(\psi_n\)</span> under several values of the intervention <span class="math inline">\(\delta\)</span>, taken from the aforementioned <span class="math inline">\(\delta\)</span>-grid. We now turn our attention to an approach for obtaining inference on a single summary measure of these estimated quantities. In particular, we propose summarizing the estimates <span class="math inline">\(\psi_n\)</span> through a marginal structural model (MSM), obtaining inference by way of a hypothesis test on a parameter of this working MSM. For a data structure <span class="math inline">\(O = (W, A, Y)\)</span>, let <span class="math inline">\(\psi_{\delta}(P_0)\)</span> be the mean outcome under a shift <span class="math inline">\(\delta\)</span> of the treatment, so that we have <span class="math inline">\(\vec{\psi}_{\delta} = (\psi_{\delta}: \delta)\)</span> with corresponding estimators <span class="math inline">\(\vec{\psi}_{n, \delta} = (\psi_{n, \delta}: \delta)\)</span>. Further, let <span class="math inline">\(\beta(\vec{\psi}_{\delta}) = \phi((\psi_{\delta}: \delta))\)</span>.</p>
<p>For a given MSM <span class="math inline">\(m_{\beta}(\delta)\)</span>, we have that <span class="math display">\[\beta_0 = \text{argmin}_{\beta} \sum_{\delta}(\psi_{\delta}(P_0) -
m_{\beta}(\delta))^2 h(\delta),\]</span> which is the solution to <span class="math display">\[u(\beta, (\psi_{\delta}: \delta)) = \sum_{\delta}h(\delta)
\left(\psi_{\delta}(P_0) - m_{\beta}(\delta) \right) \frac{d}{d\beta}
m_{\beta}(\delta) = 0.\]</span> This then leads to the following expansion <span class="math display">\[\beta(\vec{\psi}_n) - \beta(\vec{\psi}_0) \approx -\frac{d}{d\beta} u(\beta_0,
\vec{\psi}_0)^{-1} \frac{d}{d\psi} u(\beta_0, \psi_0)(\vec{\psi}_n -
\vec{\psi}_0),\]</span> where we have <span class="math display">\[\frac{d}{d\beta} u(\beta, \psi) = -\sum_{\delta} h(\delta) \frac{d}{d\beta}
m_{\beta}(\delta)^t \frac{d}{d\beta} m_{\beta}(\delta)
-\sum_{\delta} h(\delta) m_{\beta}(\delta) \frac{d^2}{d\beta^2}
m_{\beta}(\delta),\]</span> which, in the case of an MSM that is a linear model (since <span class="math inline">\(\frac{d^2}{d\beta^2} m_{\beta}(\delta) = 0\)</span>), reduces simply to <span class="math display">\[\frac{d}{d\beta} u(\beta, \psi) = -\sum_{\delta} h(\delta) \frac{d}{d\beta}
m_{\beta}(\delta)^t \frac{d}{d\beta} m_{\beta}(\delta),\]</span> and <span class="math display">\[\frac{d}{d\psi}u(\beta, \psi)(\psi_n - \psi_0) = \sum_{\delta} h(\delta)
\frac{d}{d\beta} m_{\beta}(\delta) (\psi_n - \psi_0)(\delta),\]</span> which we may write in terms of the efficient influence function (EIF) of <span class="math inline">\(\psi\)</span> by using the first order approximation <span class="math inline">\((\psi_n - \psi_0)(\delta) = \frac{1}{n}\sum_{i = 1}^n \text{EIF}_{\psi_{\delta}}(O_i)\)</span>, where <span class="math inline">\(\text{EIF}_{\psi_{\delta}}\)</span> is the efficient influence function (EIF) of <span class="math inline">\(\vec{\psi}\)</span>.</p>
<p>Now, say, <span class="math inline">\(\vec{\psi} = (\psi(\delta): \delta)\)</span> is d-dimensional, then we may write the efficient influence function of the MSM parameter <span class="math inline">\(\beta\)</span> (assuming a linear MSM) as follows <span class="math display">\[\text{EIF}_{\beta}(O) = \left(\sum_{\delta} h(\delta) \frac{d}{d\beta}
m_{\beta}(\delta) \frac{d}{d\beta} m_{\beta}(\delta)^t \right)^{-1} \cdot
\sum_{\delta} h(\delta) \frac{d}{d\beta} m_{\beta}(\delta)
\text{EIF}_{\psi_{\delta}}(O),\]</span> where the first term is of dimension <span class="math inline">\(d \times d\)</span> and the second term is of dimension <span class="math inline">\(d \times 1\)</span>.</p>
<p>In an effort to generalize still further, consider the case where <span class="math inline">\(\psi_{\delta}(P_0) \in (0, 1)\)</span> – that is, <span class="math inline">\(\psi_{\delta}(P_0)\)</span> corresponds to the probability of some event of interest. In such a case, it would be more natural to consider a logistic MSM <span class="math display">\[m_{\beta}(\delta) = \frac{1}{1 + \exp(-f_{\beta}(\delta))},\]</span> where <span class="math inline">\(f_{\beta}\)</span> is taken to be linear in <span class="math inline">\(\beta\)</span> (e.g., <span class="math inline">\(f_{\beta} = \beta_0 + \beta_1 \delta + \ldots\)</span>). In such a case, we have the parameter of interest <span class="math display">\[\beta_0 = \text{argmax}_{\beta} \sum_{\delta} \left(\psi_{\delta}(P_0)
\text{log} m_{\beta}(\delta) + (1 - \psi_{\delta}(P_0))\log(1 -
m_{\beta}(\delta))\right)h(\delta),\]</span> where <span class="math inline">\(\beta_0\)</span> solves the following <span class="math display">\[
\sum_{\delta} h(\delta) \frac{d}{d\beta} f_{\beta}(\delta) (\psi_{\delta}(P_0)
- m_{\beta}(\delta)) = 0.\]</span></p>
<p>Inference from a working MSM is rather straightforward. To wit, the limiting distribution for <span class="math inline">\(m_{\beta}(\delta)\)</span> may be expressed <span class="math display">\[\sqrt{n}(\beta_n - \beta_0) \to N(0, \Sigma),\]</span> where <span class="math inline">\(\Sigma\)</span> is the empirical covariance matrix of <span class="math inline">\(\text{EIF}_{\beta}(O)\)</span>.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">msm &lt;-<span class="st"> </span><span class="kw"><a href="../reference/trend_msm.html">trend_msm</a></span>(tmle_fit, delta_grid)</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">msm</a></code></pre></div>
<pre><code>##               ci_low param_est   ci_high   param_se      p_value
## intercept  1.4242016 1.5486582 1.6731148 0.06349942 2.26287e-131
## delta_grid 0.9279261 0.9527982 0.9776703 0.01269010  0.00000e+00</code></pre>
</div>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-diaz2012population">
<p>Díaz, Iván, and Mark J van der Laan. 2012. “Population Intervention Causal Effects Based on Stochastic Interventions.” <em>Biometrics</em> 68 (2). Wiley Online Library: 541–49.</p>
</div>
<div id="ref-diaz2018stochastic">
<p>———. 2018. “Stochastic Treatment Regimes.” In <em>Targeted Learning in Data Science: Causal Inference for Complex Longitudinal Studies</em>, 167–80. Springer Science &amp; Business Media.</p>
</div>
<div id="ref-vdl2007super">
<p>van der Laan, Mark J, Eric C Polley, and Alan E Hubbard. 2007. “Super Learner.” <em>Statistical Applications in Genetics and Molecular Biology</em> 6 (1).</p>
</div>
<div id="ref-vdl2011targeted">
<p>van der Laan, Mark J, and Sherri Rose. 2011. <em>Targeted Learning: Causal Inference for Observational and Experimental Data</em>. Springer Science &amp; Business Media.</p>
</div>
<div id="ref-vdl2018targeted">
<p>———. 2018. <em>Targeted Learning in Data Science: Causal Inference for Complex Longitudinal Studies</em>. Springer Science &amp; Business Media.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#data-and-notation">Data and Notation</a></li>
      <li><a href="#methodology">Methodology</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Nima Hejazi, Jeremy Coyle, Mark van der Laan.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
